---
// Carica i dati dal file JSON locale
import galleryData from "../data/pixar_archivio.json";

// Prepara i dati con percorsi ottimizzati per WebP
// Generate random color for placeholder
function getRandomColor(seed: number): string {
	const colors = [
		"#FF6B6B",
		"#4ECDC4",
		"#45B7D1",
		"#FFA07A",
		"#98D8C8",
		"#F7DC6F",
		"#BB8FCE",
		"#85C1E2",
		"#F8B195",
		"#6C5CE7",
		"#A8E6CF",
		"#FFD3B6",
		"#FFAAA5",
		"#FF8B94",
		"#C7CEEA",
	];
	return colors[seed % colors.length];
}

const processedData = galleryData.map((item, index) => {
	const raw: any = item;
	// New JSON uses Italian keys. Extract all needed columns.
	const id = raw.ID ?? index + 1;
	const personaggio = raw["Personaggio/soggetto"] || "";
	const film = raw["Film/corto"] || "";
	const anno = raw.Anno || "";
	const category = raw["Categoria Innovazione (tag)"] || "";
	const nomeInnovazione = raw["Nome Innovazione"] || "";

	// Prefer `Copertina` if present, otherwise look for the first ImgXX field
	let src = raw.Copertina || "";
	if (!src) {
		for (let i = 1; i <= 10; i++) {
			const key = `Img${String(i).padStart(2, "0")}`;
			if (raw[key]) {
				src = raw[key];
				break;
			}
		}
	}

	const extPattern = new RegExp("\\.(jpg|jpeg|png|webp|avif)$", "i");
	const filename = src ? src.split("/").pop() || "" : "";
	const nameWithoutExt = filename.replace(extPattern, "");

	// Generate placeholder color if no image
	const placeholderColor = !src ? getRandomColor(index) : null;

	return {
		ID: id,
		PERSONAGGIO: personaggio,
		FILM: film,
		ANNO: anno,
		CATEGORY: category,
		NOME_INNOVAZIONE: nomeInnovazione,
		SRC: src,
		optimizedSrc: nameWithoutExt ? `/images/${nameWithoutExt}.webp` : "",
		placeholderColor: placeholderColor,
		// keep the original raw item available if needed
		raw: raw,
	};
});
---

<div class="archive-container">
	<div class="archive-header">
		<span class="header-id">ID</span>
		<span class="header-personaggio">Personaggio</span>
		<span class="header-film">Film</span>
		<span class="header-anno">Anno</span>
		<span class="header-category">Categoria Innovazione</span>
		<span class="header-innovation">Nome Innovazione</span>
	</div>
	<div class="archive-list">
		{
			processedData.map(item => (
				<a
					href={`/film/${item.ID}`}
					class="archive-item"
					data-image={item.optimizedSrc}
					data-placeholder={item.placeholderColor}
					data-name={item.PERSONAGGIO || item.FILM}
				>
					<span class="item-id">[{String(item.ID).padStart(2, "0")}]</span>
					<span class="item-personaggio">{item.PERSONAGGIO}</span>
					<span class="item-film">{item.FILM}</span>
					<span class="item-anno">{item.ANNO}</span>
					<span class="item-category">{item.CATEGORY}</span>
					<span class="item-innovation">{item.NOME_INNOVAZIONE}</span>
				</a>
			))
		}
	</div>
	<div id="hover-image" class="hover-image">
		<div class="placeholder-box"></div>
		<img src="" alt="" />
	</div>
</div>

<style>
	.archive-container {
		width: 100%;
		min-height: 100vh;
		padding: 4rem 1rem;
		margin-top: 0;
	}

	.archive-list {
		width: 100%;
	}

	.archive-header {
		display: grid;
		grid-template-columns: 60px 1fr 1fr 80px 200px 1fr;
		gap: 1rem;
		font-family: var(--font-family);
		font-size: var(--font-size);
		font-weight: 400;
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
	}

	.header-id,
	.header-personaggio,
	.header-film,
	.header-anno,
	.header-category,
	.header-innovation {
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.archive-item {
		display: grid;
		grid-template-columns: 60px 1fr 1fr 80px 200px 1fr;
		gap: 1rem;
		text-decoration: none;
		color: #000000;
		font-family: var(--font-family);
		transition: transform 0.1s ease;
	}

	.archive-item:hover {
		transform: translateX(20px);
	}

	.item-id {
		font-size: var(--font-size);
		font-weight: 400;
	}

	.item-personaggio,
	.item-film {
		font-size: var(--font-size);
		font-weight: 400;
		letter-spacing: 0.02em;
	}

	.item-anno {
		font-size: var(--font-size);
		font-weight: 400;
		text-align: left;
	}

	.item-category {
		font-size: var(--font-size);
		font-weight: 400;
		text-transform: capitalize;
		text-align: left;
	}

	.item-innovation {
		font-size: var(--font-size);
		font-weight: 400;
		text-align: left;
	}

	.hover-image {
		position: fixed;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.3s ease;
		z-index: 1;
	}

	.hover-image.visible {
		opacity: 1;
	}

	.hover-image img {
		width: 150px;
		height: auto;
		display: block;
		object-fit: cover;
	}

	.hover-image .placeholder-box {
		width: 150px;
		height: 112px;
		display: none;
		position: absolute;
		top: 0;
		left: 0;
	}

	@media (max-width: 768px) {
		.archive-container {
			padding: 3rem 1rem 2rem 1rem;
		}

		.archive-header {
			grid-template-columns: 40px 1fr 1fr 60px 120px 1fr;
			gap: 0.5rem;
			font-size: 0.65rem;
			margin-bottom: 0.5rem;
		}

		.archive-item {
			grid-template-columns: 40px 1fr 1fr 60px 120px 1fr;
			gap: 0.5rem;
			padding: 0.4rem 0;
		}

		.item-id,
		.item-personaggio,
		.item-film,
		.item-anno,
		.item-category,
		.item-innovation {
			font-size: 0.7rem;
		}

		.hover-image img {
			width: 100px;
		}

		.hover-image .placeholder-box {
			width: 100px;
			height: 75px;
		}
	}
</style>

<script>
	const archiveItems = document.querySelectorAll(".archive-item");
	const hoverImage = document.getElementById("hover-image");
	const hoverImg = hoverImage?.querySelector("img");
	const placeholderBox = hoverImage?.querySelector(
		".placeholder-box"
	) as HTMLElement;

	const totalItems = archiveItems.length;

	// Function to get bouncing position based on item index
	function getBouncingPosition(index: number) {
		const viewportWidth = window.innerWidth;
		const viewportHeight = window.innerHeight;
		const imageWidth = 150;
		const imageHeight = 112;

		// Normalize index to 0-1 range
		const normalizedIndex = index / (totalItems - 1);

		// X position: linear from left to right
		const margin = 50;
		const xPosition =
			margin + (viewportWidth - 2 * margin - imageWidth) * normalizedIndex;

		// Y position: create 4 bounces with varying heights
		const bounces = 4;
		const baseY = viewportHeight - imageHeight - margin; // Bottom baseline

		// Sine wave for bouncing
		const sineValue = Math.abs(Math.sin(normalizedIndex * Math.PI * bounces));

		// Determine which bounce we're in (0, 1, 2, or 3)
		const bouncePhase = Math.floor(normalizedIndex * bounces);

		// Different amplitudes for each bounce: progressive height increase
		let amplitude;
		if (bouncePhase < 3) {
			amplitude = viewportHeight * 0.15; // First three bounces: lower
		} else {
			amplitude = viewportHeight * 0.4; // Last bounce: much higher
		}

		const yPosition = baseY - amplitude * sineValue;

		// Ensure Y position stays within viewport
		const clampedY = Math.max(
			margin,
			Math.min(yPosition, viewportHeight - imageHeight - margin)
		);

		return { x: xPosition, y: clampedY };
	}

	archiveItems.forEach((item, index) => {
		item.addEventListener("mouseenter", e => {
			const target = e.currentTarget as HTMLElement;
			const imageSrc = target.getAttribute("data-image");
			const placeholderColor = target.getAttribute("data-placeholder");
			const imageName = target.getAttribute("data-name");

			if (hoverImage) {
				// Get bouncing position based on index
				const pos = getBouncingPosition(index);
				hoverImage.style.left = pos.x + "px";
				hoverImage.style.top = pos.y + "px";

				if (imageSrc && hoverImg) {
					// Show image
					hoverImg.src = imageSrc;
					hoverImg.alt = imageName || "";
					hoverImg.style.display = "block";
					if (placeholderBox) placeholderBox.style.display = "none";
				} else if (placeholderColor && placeholderBox) {
					// Show placeholder color
					placeholderBox.style.backgroundColor = placeholderColor;
					placeholderBox.style.display = "block";
					if (hoverImg) hoverImg.style.display = "none";
				}
				hoverImage.classList.add("visible");
			}
		});

		item.addEventListener("mouseleave", () => {
			if (hoverImage) {
				hoverImage.classList.remove("visible");
			}
		});
	});
</script>
